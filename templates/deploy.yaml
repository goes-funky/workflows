name: Deploy

includes:
  - common/deploy.yaml

fragments:
  workflow-call-deploy: &workflow-call-deploy
  step-setup-ssh-agent: &step-setup-ssh-agent
  step-setup-gcloud: &step-setup-gcloud
  job-build: &job-build
  job-deploy: &job-deploy

on:

jobs:
  build: 
    name: Build Docker images
    if: "github.event.ref == 'refs/heads/master' || startsWith(github.event.ref, 'refs/tags/v')"
    <<: *job-build

  deploy-environment:
    name: Deploy to environment
    if: "!inputs.skip-deploy && inputs.environment"
    needs: [build]
    environment: ${{ inputs.environment }}
    <<: *job-deploy

  deploy-development:
    name: Deploy to development
    if: "!inputs.skip-deploy && (github.event.ref == 'refs/heads/master' || startsWith(github.event.ref, 'refs/tags/v'))"
    needs: [build]
    environment: development
    <<: *job-deploy

  deploy-production:
    name: Deploy to production
    if: "!inputs.skip-deploy && (startsWith(github.event.ref, 'refs/tags/v'))"
    needs: [build, deploy-development]
    environment: production
    <<: *job-deploy